# Clipper - 剪贴板历史管理工具

基于 Rust + Tauri 2.x + Svelte 5 的剪贴板历史管理工具。

## 技术栈

| 组件 | 技术方案 |
|------|----------|
| 语言 | Rust |
| GUI框架 | Tauri 2.x + Svelte 5 |
| 剪贴板 | arboard 3.4 |
| 键盘模拟 | enigo 0.1 |
| 数据库 | rusqlite + SQLite |
| 快捷键 | Tauri GlobalShortcut |
| 系统托盘 | Tauri SystemTray |

## 项目结构

```
clipper/
├── src/
│   ├── routes/
│   │   └── +page.svelte      # 主页面
│   └── lib/
│       ├── components/
│       │   ├── ClipboardItem.svelte
│       │   ├── ClipboardList.svelte
│       │   └── SearchBar.svelte
│       └── types.ts
├── src-tauri/
│   ├── src/
│   │   ├── lib.rs             # Tauri 后端入口
│   │   ├── clipboard.rs       # 剪贴板操作 (arboard + enigo)
│   │   ├── commands.rs        # Tauri 命令
│   │   ├── database.rs        # SQLite 操作
│   │   ├── models.rs          # 数据模型
│   │   └── tray.rs            # 系统托盘
│   └── Cargo.toml
└── package.json
```

## 当前状态

### 已实现功能
- [x] 剪贴板监听（应用启动自动开始）
- [x] 历史记录存储（SQLite）
- [x] 文本去重（命中时不新增记录，刷新原记录时间戳并收敛重复项）
- [x] 搜索功能（历史/收藏视图均可搜索）
- [x] 每次重新呼出主窗口时自动清空搜索状态（回到主列表）
- [x] 系统托盘
- [x] 托盘菜单（设置 / 关于 / 退出）
- [x] 托盘“关于”面板（版本号 + 作者）
- [x] 暗色模式
- [x] 主题化滚动条（亮色/暗色下滚动条风格一致）
- [x] 快捷键呼出菜单（默认 `Ctrl+Shift+V`，支持设置页下拉 + 按键捕获修改）
- [x] 快捷键呼出位置跟随当前鼠标位置，并做屏幕工作区约束（含任务栏避让）
- [x] 点击记录粘贴到焦点窗口（单次粘贴，已修复重复粘贴）
- [x] 设置界面（托盘入口，基础项：主题/保留天数/最大记录/快捷键）
- [x] 收藏导入/导出（JSON，设置页入口，导出可选目录，导入为增量）
- [x] 主窗口外部点击自动隐藏（托盘驻留）
- [x] 主窗口不显示任务栏图标（托盘运行）
- [x] 收藏功能（收藏/取消收藏、收藏视图切换）
- [x] 手动添加收藏文本（主界面 `+` 按钮弹窗输入）
- [x] 记录置顶功能（置顶/取消置顶，列表按置顶优先）
- [x] 窗口尺寸持久化（保存用户调整后的窗口宽高）
- [x] 最小窗口限制（宽 `300` / 高 `400`）
- [x] 启动窗口体验优化（去除启动闪屏与首屏 Loading 动画）

### 当前限制（v1）
- [ ] 图片记录监听已暂时关闭（为保证性能与稳定性，当前版本以文本为主）
- [ ] 图片记录回贴能力暂缓，后续版本重构优化后恢复

---

## 开发进度与已知问题

### 2026-02-12

#### 本轮完成
1. ✅ 设置体验完善：设置入口固定在托盘；快捷键配置支持“修饰键下拉 + 按键捕获”，保存后即时重绑生效。
2. ✅ 主窗口行为优化：窗口大小持久化、最小尺寸限制、启动不闪屏、首次无 Loading。
3. ✅ 外部点击隐藏链路修复：修复延迟与偶发不关闭问题，保留缩放场景防误触策略。
4. ✅ 收藏体系落地：收藏/取消收藏、收藏视图、收藏搜索、手动添加收藏文本。
5. ✅ 记录操作增强：新增置顶功能，历史和收藏列表统一按“置顶优先 + 时间倒序”展示。
6. ✅ 主界面交互精简：移除刷新/测试按钮，改为星标切换视图 + `+` 添加收藏。
7. ✅ 数据洁净策略：文本去重改为“更新时间戳并保留单条记录”。
8. ✅ 数据交换能力：收藏支持 JSON 导入/导出（导入增量、导出目录选择）。
9. ✅ 托盘体验更新：移除“显示主界面”项，新增“关于”（版本号 + 作者）。
10. ✅ 视觉一致性：滚动条已按亮/暗主题适配，减少风格冲突。
11. ✅ 搜索状态优化：窗口重新呼出后自动退出搜索状态并恢复主列表。

#### 已知问题（待后续修复）
1. ⚠️ 图片链路暂缓（记录与回贴均未作为 v1 正式能力），后续版本再开启并专项优化。

---

## v1 发布准备

1. [x] 功能范围冻结（文本主链路、收藏、设置、托盘能力已完成）
2. [x] 关键交互收敛（外部点击隐藏、搜索状态复位、窗口尺寸持久化）
3. [x] 文档同步（当前 README 与实现一致）
4. [ ] 发布前检查
说明：执行 `npm run check`、`cargo check`、基础手工回归（快捷键呼出/粘贴/收藏/导入导出/设置保存）。
5. [ ] 首版打包与验收
说明：执行 `npm run tauri build`，验证安装包启动、托盘图标、开机后首次呼出体验。

## v1 后续规划（草案）

1. [ ] 图片链路重构（记录与回贴性能优化后恢复）
2. [ ] 更细粒度设置项（如去重策略开关、更多显示偏好）
3. [ ] 可靠性增强（异常场景日志与恢复策略）

## 依赖说明

### 剪贴板操作 (arboard)
```rust
use arboard::Clipboard;

// 读取剪贴板
let text = clipboard.get_text();

// 写入剪贴板
clipboard.set_text("内容");
```

### 键盘模拟 (enigo)
```rust
use enigo::{Enigo, Key, KeyboardControllable};

let mut enigo = Enigo::new();
enigo.key_down(Key::Control);
enigo.key_click(Key::Layout('v'));  // v0.1 API
enigo.key_up(Key::Control);
```

### 图片编码 (image)
```rust
use image::{codecs::png::PngEncoder, ColorType, ImageEncoder};
```

## 数据库

- 路径: `%APPDATA%\Clipper\clipper.db`
- 表: `clipboard_history`, `settings`

## 运行命令

```bash
# 开发模式
npm run tauri dev

# 打包
npm run tauri build
```
